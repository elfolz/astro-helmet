<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<style>
			body {
				margin: 0 auto;
				background-color: #121212;
			}
			input[type=file] {
				display: none;
			}
			main {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			main footer {
				display: flex;
				justify-content: space-evenly;
				align-items: center;
				margin-top: 12px;
			}
			button {
				width: 128px;
				height: 36px;
				cursor: pointer;
				border-radius: 8px;
				border: none;
				background-color: rgb(64,64,64);
				color: #fff;
				text-transform: uppercase;
				transition: all 250ms ease-in-out;
			}
			button:hover {
				background-color: rgb(128,128,128);
			}
		</style>
	</head>
	<body>
		<main>
			<canvas title="Enviar imagem"></canvas>
			<footer>
				<button id="changePicture">Mudar foto</button>
				<button id="downloadPicture">Baixar foto</button>
			</footer>
			<input type="file">
		</main>
		<script>
			const profile = new Image()
			profile.crossOrigin = 'anonymous'
			const helmet = new Image()
			helmet.crossOrigin = 'anonymous'
			helmet.src = 'helmet.png'
			const canvas = document.querySelector('canvas')
			const context = canvas.getContext('2d')
			const reader = new FileReader()
			profile.onload = () => {
				let helmetSize = Math.min(helmet.width, helmet.height)
				let profileSize = Math.min(profile.naturalWidth, profile.naturalHeight)
				let ratio = helmetSize / profileSize
				profile.width = profile.naturalWidth * ratio * 0.75
				profile.height = profile.naturalHeight * ratio * 0.75
				refreshCanvas()
			}
			helmet.onload = () => {
				canvas.width = helmet.naturalWidth
				canvas.height = helmet.naturalHeight
				refreshCanvas()
			}
			reader.onload = e => {
				profile.src = e.target.result
			}
			document.querySelector('#changePicture').onclick = () => {
				document.querySelector('input[type=file]').click()
			}
			document.querySelector('#downloadPicture').onclick = () => {
				downloadPicture()
			}
			document.querySelector('input[type=file]').onchange = e => {
				let picture = e.target.files[0]
				if (picture) reader.readAsDataURL(picture)
			}
			function refreshCanvas() {
				context.clearRect(0, 0, canvas.width, canvas.height)
				context.drawImage(profile, (helmet.width-profile.width)/2, (helmet.height-profile.height)/3, profile.width, profile.height)
				context.clearRect(0, 0, helmet.width, 44)
				context.clearRect(0, 0, 78, helmet.height)
				context.clearRect(helmet.width-78, 0, 78, helmet.height)
				context.clearRect(78, 44, 44, 44)
				context.clearRect(helmet.width-78-44, 44, 44, 44)
				context.clearRect(78, helmet.height-44-44, 44, 44)
				context.clearRect(helmet.width-78-44, helmet.height-44-44, 44, 44)
				context.drawImage(helmet, 0, 0, helmet.width, helmet.height)
			}
			function downloadPicture() {
				let link = document.createElement('a')
				link.setAttribute('dowload', 'Astro-helmet')
				link.href = canvas.toDataURL()
				document.documentElement.appendChild(link)
				link.click()
				setTimeout(() => {document.documentElement.removeChild(link), 100})
			}
		</script>
	</body>
</html>